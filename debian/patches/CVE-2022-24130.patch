Description: Cherry-pick sixel graphics fixes from xterm 370d and 370f
 Check for out-of-bounds condition while drawing sixels, and quit that
 operation (report by Nick Black, CVE-2022-24130).
Bug-Debian: https://bugs.debian.org/1004689
Author: Utkarsh Gupta <utkarsh@debian.org>

--- a/graphics_sixel.c
+++ b/graphics_sixel.c
@@ -140,7 +140,7 @@
     graphic->color_registers_used[context->background] = 1;
 }
 
-static void
+static Boolean
 set_sixel(Graphic *graphic, SixelContext const *context, int sixel)
 {
     RegisterNum color;
@@ -159,7 +159,9 @@
 	   ((color != COLOR_HOLE)
 	    ? (unsigned) graphic->color_registers[color].b : 0U)));
     for (pix = 0; pix < 6; pix++) {
-	if (context->col < graphic->max_width &&
+	if (context->col >= 0 &&
+	    context->col < graphic->max_width &&
+	    context->row + pix >= 0 &&
 	    context->row + pix < graphic->max_height) {
 	    if (sixel & (1 << pix)) {
 		if (context->col + 1 > graphic->actual_width) {
@@ -175,8 +177,10 @@
 	    }
 	} else {
 	    TRACE(("sixel pixel %d out of bounds\n", pix));
+	    return False;
 	}
     }
+    return True;
 }
 
 static void
@@ -375,7 +379,10 @@
 		init_sixel_background(graphic, &context);
 		graphic->valid = 1;
 	    }
-	    set_sixel(graphic, &context, sixel);
+	    if (!set_sixel(graphic, &context, sixel)) {
+	      context.col = 0;
+	      break;
+	    }
 	    context.col++;
 	} else if (ch == '$') {	/* DECGCR */
 	    /* ignore DECCRNLM in sixel mode */
@@ -453,8 +460,12 @@
 		graphic->valid = 1;
 	    }
 	    for (i = 0; i < Pcount; i++) {
-		set_sixel(graphic, &context, sixel);
-		context.col++;
+		if (set_sixel(graphic, &context, sixel)) {
+		  context.col++;
+		} else {
+		  context.col = 0;
+		  break;
+		}
 	    }
 	} else if (ch == '#') {	/* DECGCI */
 	    ANSI color_params;
